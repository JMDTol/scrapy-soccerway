# -*- coding: utf-8 -*-
from scrapy import Spider, Request
from scrapy.loader import ItemLoader
from soccerway.items import Venue
from urllib.parse import urlencode, urlparse, parse_qs
from datetime import datetime, timezone
from soccerway.competitions import competitions_id_list
from random import randint

nonexistent = [1, 2, 4, 5, 13, 17, 19, 46, 51, 52, 54, 68, 70, 74, 78, 79, 80, 82, 143, 144, 146, 145, 147, 148, 149, 150, 151, 152, 153, 154, 156, 157, 155, 158, 167, 206, 205, 225, 234, 256, 261, 277, 303, 312, 318, 320, 325, 329, 331, 332, 361, 374, 376, 377, 375, 379, 382, 385, 387, 392, 401, 402, 403, 404, 405, 406, 407, 409, 436, 438, 441, 442, 448, 476, 482, 516, 528, 537, 541, 543, 550, 567, 577, 580, 600, 602, 622, 656, 657, 658, 659, 660, 661, 662, 667, 673, 882, 1106, 1198, 1236, 1237, 1238,
        1241, 1297, 1506, 1621, 1828, 1836, 1863, 1990, 2096, 2099, 2116, 2117, 2118, 2119, 2283, 2285, 2369, 2414, 2439, 2487, 2492, 2507, 2616, 2684, 2838, 3128, 3202, 3291, 3294, 3419, 3498, 3544, 3584, 3680, 3704, 3712, 3810, 3847, 3964, 3971, 4007, 4021, 4057, 4061, 4107, 4372, 4391, 4553, 4570, 4612, 4703, 4816, 4826, 4849, 5046, 5267, 5344, 5445, 5472, 5623, 5631, 5725, 5833, 6464, 6632, 6671, 6682, 6689, 6696, 6818, 6888, 6897, 7052, 7076, 7265, 7419, 7544, 7786, 7872, 8420,
        8483, 8526, 8627, 8710, 8758, 8798, 8936, 9550, 9821, 10144, 10249, 10440, 10551, 10582, 10583, 10707, 10940, 10999, 11124, 11225, 11256, 11410, 11656, 11735, 11795, 12094, 12742, 13318, 13350, 13356, 13387, 13409, 13553, 13611, 13637, 13924, 14158, 14231, 14306, 14437, 14467, 14596, 14768, 14872, 14908, 14914, 15249, 15450, 15454, 15645, 15696, 15813, 15827, 15891, 16012, 16023, 16088, 16176, 16313, 16426, 16565, 16713, 16720, 16726, 16732, 16766, 16940, 16980, 17373,
        17390, 17632, 17823, 17949, 18183, 18386, 18551, 18604, 18648, 18730, 19121, 19191, 19194, 19268, 19345, 20082, 20178, 20255, 20264, 20292, 20295, 20303, 20408, 20414, 20497, 20553, 20638, 20729, 20733, 20774, 20776, 20778, 20780, 20782, 20784, 20786, 20788, 20790, 20792, 20794, 20796, 20798, 20800, 20802, 20804, 20806, 20808, 20810, 20812, 20814, 20816, 20818, 20820, 20822, 20824, 20826, 20828, 20830, 20832, 20834, 20836, 20838, 20840, 20842, 20844, 20846, 20848, 20850,
        20852, 20854, 20856, 20858, 20860, 20862, 20864, 20866, 20868, 20870, 20872, 20874, 20876, 20878, 20880, 20882, 20884, 20886, 20888, 20890, 20892, 20894, 20896, 20898, 20900, 20902, 20904, 20906, 20908, 20910, 20912, 20914, 20916, 20918, 20920, 20922, 20924, 20926, 20928, 20930, 20932, 20934, 20936, 20938, 20940, 20942, 20944, 20946, 20948, 20949, 20950, 20952, 20954, 20956, 20958, 20960, 20962, 20964, 20966, 20968, 20970, 20972, 20974, 20976, 20978, 20980, 20982, 20984,
        20986, 20988, 20990, 20992, 20994, 20996, 20998, 21000, 21002, 21004, 21006, 21008, 21010, 21012, 21014, 21016, 21018, 21020, 21022, 21024, 21026, 21028, 21030, 21032, 21034, 21036, 21038, 21040, 21042, 21044, 21046, 21048, 21050, 21052, 21054, 21056, 21058, 21060, 21062, 21064, 21066, 21068, 21070, 21072, 21074, 21076, 21078, 21080, 21082, 21084, 21086, 21088, 21090, 21092, 21094, 21096, 21098, 21100, 21102, 21104, 21105, 21106, 21108, 21110, 21112, 21114, 21116, 21118,
        21120, 21122, 21124, 21126, 21128, 21130, 21132, 21134, 21136, 21138, 21140, 21142, 21144, 21146, 21148, 21150, 21152, 21154, 21156, 21158, 21160, 21162, 21164, 21166, 21168, 21170, 21172, 21174, 21176, 21178, 21180, 21182, 21184, 21186, 21188, 21190, 21192, 21194, 21196, 21198, 21200, 21202, 21204, 21206, 21208, 21210, 21212, 21214, 21216, 21218, 21220, 21222, 21224, 21226, 21228, 21230, 21232, 21234, 21236, 21238, 21240, 21242, 21244, 21246, 21248, 21250, 21252, 21254,
        21256, 21258, 21260, 21262, 21264, 21266, 21268, 21270, 21272, 21274, 21276, 21278, 21280, 21282, 21284, 21286, 21288, 21290, 21292, 21294, 21296, 21298, 21300, 21302, 21304, 21306, 21308, 21310, 21312, 21314, 21316, 21318, 21320, 21322, 21324, 21326, 21328, 21330, 21332, 21334, 21336, 21338, 21340, 21342, 21344, 21346, 21348, 21350, 21352, 21354, 21356, 21358, 21360, 21362, 21364, 21366, 21368, 21370, 21372, 21374, 21376, 21378, 21380, 21382, 21384, 21386, 21388, 21390,
        21392, 21394, 21396, 21398, 21400, 21402, 21404, 21406, 21408, 21410, 21412, 21414, 21416, 21418, 21420, 21422, 21424, 21426, 21428, 21430, 21432, 21434, 21436, 21438, 21440, 21442, 21444, 21446, 21448, 21450, 21452, 21454, 21456, 21458, 21460, 21462, 21464, 21466, 21468, 21470, 21472, 21474, 21476, 21478, 21480, 21482, 21484, 21486, 21488, 21490, 21492, 21494, 21496, 21498, 21500, 21502, 21504, 21506, 21508, 21510, 21512, 21514, 21516, 21518, 21520, 21522, 21524, 21526,
        21528, 21530, 21532, 21534, 21536, 21538, 21540, 21542, 21544, 21546, 21548, 21550, 21552, 21554, 21556, 21558, 21560, 21562, 21564, 21566, 21568, 21570, 21572, 21574, 21576, 21578, 21580, 21582, 21584, 21586, 21588, 21590, 21592, 21594, 21596, 21598, 21600, 21602, 21604, 21606, 21608, 21610, 21612, 21614, 21616, 21618, 21620, 21622, 21623, 21624, 21626, 21628, 21630, 21632, 21634, 21636, 21638, 21640, 21642, 21644, 21646, 21648, 21650, 21652, 21654, 21656, 21658, 21660,
        21662, 21664, 21665, 21666, 21668, 21670, 21672, 21674, 21676, 21678, 21680, 21682, 21684, 21686, 21688, 21690, 21692, 21694, 21696, 21698, 21700, 21702, 21704, 21706, 21708, 21710, 21712, 21714, 21716, 21718, 21720, 21722, 21724, 21726, 21728, 21730, 21732, 21734, 21736, 21738, 21740, 21742, 21744, 21746, 21748, 21750, 21752, 21754, 21756, 21758, 21760, 21762, 21764, 21766, 21768, 21770, 21772, 21774, 21776, 21778, 21780, 21782, 21784, 21786, 21788, 21790, 21792, 21794,
        21796, 21798, 21800, 21802, 21804, 21806, 21808, 21810, 21812, 21814, 21815, 21816, 21820, 21818, 21822, 21824, 21826, 21828, 21830, 21832, 21833, 21834, 21836, 21838, 21840, 21842, 21844, 21846, 21848, 21850, 21852, 21854, 21856, 21864, 21858, 21866, 21862, 21868, 21870, 21872, 21874, 21876, 21878, 21860, 21880, 21882, 21884, 21886, 21888, 21890, 21892, 21894, 21896, 21898, 21900, 21902, 21904, 21906, 21908, 21910, 21912, 21913, 21914, 21916, 21918, 21920, 21922, 21924,
        21926, 21928, 21930, 21932, 21934, 21936, 21938, 21940, 21942, 21944, 21946, 21948, 21950, 21952, 21954, 21956, 21958, 21960, 21962, 21964, 21966, 21968, 21970, 21972, 21974, 21976, 21978, 21980, 21982, 21984, 21986, 21988, 21990, 21992, 21994, 21996, 21998, 22000, 22002, 22004, 22006, 22008, 22010, 22012, 22014, 22016, 22018, 22020, 22022, 22024, 22026, 22028, 22030, 22032, 22034, 22036, 22038, 22040, 22042, 22044, 22046, 22048, 22050, 22052, 22054, 22056, 22058, 22060,
        22062, 22064, 22066, 22068, 22070, 22072, 22074, 22076, 22078, 22080, 22082, 22084, 22086, 22088, 22090, 22092, 22094, 22096, 22098, 22100, 22102, 22104, 22106, 22108, 22110, 22112, 22114, 22116, 22118, 22120, 22122, 22124, 22126, 22128, 22129, 22130, 22132, 22134, 22136, 22138, 22140, 22142, 22144, 22146, 22148, 22150, 22152, 22154, 22156, 22158, 22160, 22162, 22164, 22166, 22168, 22170, 22172, 22174, 22176, 22178, 22180, 22182, 22184, 22186, 22188, 22190, 22192, 22194,
        22196, 22198, 22200, 22202, 22204, 22206, 22208, 22210, 22212, 22214, 22216, 22218, 22220, 22222, 22224, 22226, 22228, 22230, 22232, 22234, 22236, 22238, 22240, 22242, 22244, 22246, 22248, 22250, 22252, 22254, 22256, 22258, 22260, 22262, 22264, 22266, 22268, 22270, 22272, 22274, 22276, 22278, 22280, 22282, 22284, 22286, 22288, 22290, 22292, 22294, 22296, 22298, 22300, 22302, 22304, 22306, 22308, 22310, 22312, 22314, 22316, 22318, 22320, 22322, 22324, 22326, 22328, 22330,
        22332, 22334, 22336, 22338, 22340, 22342, 22344, 22346, 22348, 22350, 22352, 22354, 22356, 22358, 22360, 22362, 22364, 22366, 22367, 22368, 22370, 22372, 22374, 22376, 22378, 22380, 22382, 22384, 22386, 22388, 22390, 22392, 22394, 22396, 22398, 22400, 22402, 22404, 22406, 22408, 22410, 22412, 22414, 22416, 22418, 22420, 22422, 22424, 22426, 22428, 22430, 22432, 22434, 22436, 22438, 22440, 22442, 22444, 22446, 22448, 22450, 22452, 22454, 22456, 22458, 22460, 22462, 22464,
        22466, 22468, 22470, 22472, 22474, 22476, 22478, 22480, 22482, 22484, 22486, 22488, 22490, 22492, 22494, 22496, 22498, 22500, 22502, 22504, 22506, 22508, 22510, 22512, 22514, 22516, 22518, 22520, 22522, 22524, 22526, 22528, 22530, 22532, 22534, 22536, 22538, 22540, 22542, 22544, 22546, 22548, 22550, 22552, 22554, 22556, 22558, 22560, 22562, 22564, 22566, 22568, 22570, 22572, 22574, 22576, 22578, 22580, 22582, 22584, 22586, 22588, 22590, 22592, 22594, 22596, 22598, 22600,
        22602, 22604, 22606, 22608, 22610, 22612, 22614, 22616, 22618, 22620, 22622, 22624, 22626, 22628, 22630, 22632, 22634, 22636, 22638, 22640, 22642, 22644, 22646, 22648, 22650, 22652, 22654, 22656, 22658, 22660, 22662, 22664, 22666, 22668, 22670, 22672, 22674, 22676, 22678, 22680, 22682, 22684, 22686, 22688, 22690, 22692, 22694, 22696, 22698, 22700, 22702, 22704, 22706, 22708, 22710, 22712, 22714, 22716, 22718, 22720, 22722, 22724, 22726, 22728, 22730, 22732, 22734, 22736,
        22738, 22740, 22742, 22744, 22746, 22748, 22750, 22752, 22754, 22756, 22758, 22760, 22762, 22764, 22766, 22768, 22770, 22772, 22774, 22776, 22778, 22780, 22782, 22784, 22786, 22788, 22790, 22791, 22792, 22794, 22796, 22798, 22800, 22802, 22804, 22806, 22808, 22810, 22812, 22814, 22816, 22818, 22820, 22822, 22824, 22826, 22828, 22830, 22832, 22834, 22836, 22838, 22840, 22842, 22844, 22846, 22856, 22848, 22850, 22858, 22852, 22860, 22854, 22862, 22864, 22866, 22868, 22870,
        22872, 22874, 22876, 22878, 22880, 22882, 22884, 22886, 22888, 22890, 22894, 22896, 22898, 22892, 22900, 22902, 22904, 22910, 22908, 22906, 22912, 22914, 22916, 22918, 22920, 22922, 22924, 22926, 22928, 22930, 22932, 22934, 22936, 22938, 22940, 22942, 22944, 22946, 22948, 22950, 22952, 22954, 22956, 22958, 22960, 22962, 22964, 22966, 22968, 22970, 22972, 22974, 22976, 22978, 22980, 22982, 22984, 22986, 22988, 22990, 22992, 22994, 22996, 22998, 23000, 23002, 23004, 23006,
        23008, 23010, 23012, 23014, 23016, 23018, 23020, 23022, 23024, 23026, 23028, 23030, 23032, 23034, 23036, 23038, 23040, 23042, 23044, 23046, 23048, 23050, 23052, 23054, 23056, 23058, 23060, 23062, 23064, 23066, 23068, 23070, 23072, 23074, 23076, 23078, 23080, 23082, 23084, 23086, 23088, 23090, 23094, 23092, 23096, 23098, 23100, 23102, 23104, 23106, 23108, 23110, 23112, 23114, 23116, 23118, 23120, 23122, 23124, 23126, 23128, 23130, 23132, 23134, 23136, 23138, 23140, 23142,
        23144, 23146, 23148, 23150, 23152, 23154, 23156, 23158, 23160, 23162, 23164, 23166, 23168, 23170, 23172, 23174, 23176, 23178, 23182, 23184, 23186, 23180, 23188, 23190, 23192, 23196, 23194, 23198, 23200, 23204, 23206, 23202, 23208, 23210, 23212, 23214, 23216, 23218, 23220, 23222, 23224, 23226, 23228, 23230, 23232, 23234, 23236, 23238, 23240, 23242, 23244, 23246, 23248, 23250, 23252, 23254, 23256, 23258, 23260, 23262, 23264, 23266, 23268, 23270, 23272, 23274, 23276, 23278,
        23280, 23281, 23282, 23536, 23568, 23597, 23606, 23650, 23752, 23788, 23863, 24007, 24018, 24038, 24039, 24057, 24058, 24065, 24077, 24081, 24091, 24115, 24150, 24180, 24439, 24486, 24492, 24493, 24498, 24510, 24528, 24606, 24622, 24829, 24910, 25028, 25079, 25084, 25094, 25212, 25230, 25268, 25269, 25270, 25767, 25995, 26420, 26595, 26663, 26728, 26729, 26760, 26803, 26938, 27076, 27412, 27596]

areas = ['afghanistan', 'albania', 'algeria', 'andorra', 'angola', 'argentina', 'armenia', 'aruba', 'australia', 'austria',
        'azerbaijan', 'bahrain', 'bangladesh', 'belarus', 'belgium', 'belize', 'benin', 'bermuda', 'bhutan', 'bolivia',
        'botswana', 'brazil', 'bulgaria', 'cambodia', 'cameroon', 'canada', 'chad', 'chile', 'colombia', 'congo', 'croatia',
        'cuba', 'cyprus', 'denmark', 'ecuador', 'england', 'estonia', 'ethiopia', 'finland', 'france', 'gabon', 'gambia',
        'georgia', 'germany', 'ghana', 'greece', 'grenada', 'guam', 'guatemala', 'guinea', 'guyana', 'honduras', 'hungary',
        'iceland', 'india', 'indonesia', 'iran', 'iraq', 'israel', 'italy', 'jamaica', 'japan', 'jordan', 'kazakhstan', 'kenya',
        'kuwait', 'kyrgyzstan', 'laos', 'latvia', 'lebanon', 'lesotho', 'liberia', 'libya', 'liechtenstein', 'lithuania',
        'luxembourg', 'macao', 'malaysia', 'malta', 'mexico', 'moldova', 'mongolia', 'morocco', 'mozambique', 'namibia', 'nepal',
        'netherlands', 'nicaragua', 'niger', 'nigeria', 'norway', 'oman', 'pakistan', 'palestine', 'panama', 'paraguay', 'peru',
        'philippines', 'poland', 'portugal', 'romania', 'russia', 'rwanda', 'samoa', 'scotland', 'senegal', 'slovakia',
        'slovenia', 'somalia', 'spain', 'sudan', 'swaziland', 'sweden', 'switzerland', 'syria', 'tajikistan', 'tanzania',
        'thailand', 'togo', 'tonga', 'tunisia', 'turkey', 'turkmenistan', 'uganda', 'ukraine', 'usa', 'uruguay',
        'uzbekistan', 'venezuela', 'vietnam', 'wales', 'yemen', 'zambia', 'zimbabwe']

areas_count = len(areas)

class VenuesSpider(Spider):
    name = "venues"
    #allowed_domains = ["http://www.soccerway.mobi"]
    start_urls = ['http://www.soccerway.mobi/?']
    params = {
        "sport": "soccer",
        "page": "match",
        "id" : "2255155",
        "localization_id": "www"
    }
    def start_requests(self):
        self.crawler.stats.set_value('nonexistent',str(nonexistent))
        start_url = 'http://int.soccerway.com/venues/{}/venue/v{}/'
        for i in range(925, 938): # 27617 on 12.04.2017, 29392 on 15.01.2018
            if i in nonexistent:
               continue
            request = Request(url=start_url.format(areas[randint(0, areas_count-1)], str(i)), callback=self.parse)
            request.meta['proxy'] = 'http://127.0.0.1:8118'
            yield request

    def parse(self, response):
        item = Venue()
        item['id'] = response.url.split('/')[-2][1:]
        if not int(item['id']):
            self.log('Skip URL: {}'.format(response.url))
            return None
        item['name'] = response.xpath('//h1/text()').extract_first()
        item['address'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Address:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Address:"]/text()').extract_first()
        item['zip'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Zip code:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Zip code:"]/text()').extract_first()
        item['city'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="City:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="City:"]/text()').extract_first()
        item['phone'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Phone:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Phone:"]/text()').extract_first()
        item['fax'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Fax:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Fax:"]/text()').extract_first()
        item['email'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="E-mail:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="E-mail:"]/a/text()').extract_first()
        item['website'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Website:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Website:"]/a/text()').extract_first()
        item['opened'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Opened:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Opened:"]/text()').extract_first()
        item['architect'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Architect:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Architect:"]/text()').extract_first()
        item['capacity'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Capacity:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Capacity:"]/text()').extract_first()
        item['surface'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Surface:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Surface:"]/text()').extract_first()
        item['previous'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Previous names:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Previous names:"]/text()').extract_first()
        item['facts'] = response.xpath('//div[@class="clearfix"]/dl/dt[.="Facts:"]/following-sibling::dd[preceding-sibling::dt[1]/text()="Facts:"]/text()').extract_first()
        script = response.xpath('//script[contains(., "setMarker")]').extract_first()
        if not script is None:
            item['lat'] = response.xpath('//script[contains(., "setMarker")]').extract_first().split('\n')[10][:-1].strip()
            item['lon'] = response.xpath('//script[contains(., "setMarker")]').extract_first().split('\n')[11][:-1].strip()
            item['link'] = response.xpath('//script[contains(., "setMarker")]').extract_first().split('\n')[19][:-1].strip().strip('"')
        #item['url'] = response.url
        item['updated'] = datetime.utcnow().isoformat(' ')
        yield item
        return item
        #self.log('URL: {}'.format(response.url))

